# Отчёт: Исправление склада ткани

## Проблема
- Отсутствовал FK relationship между `warehouse_fabrics` и `warehouse_balances`
- PostgREST не мог сделать join → ошибка "Could not find a relationship"
- Не было возможности добавлять новую ткань в справочник из UI

## Решение

### 1. SQL миграция для исправления relationship

**Файл:** `supabase/migrations/20250127_fix_warehouse_relationships.sql`

**Что делает:**
- Добавляет уникальный индекс `(org_id, lower(name))` для case-insensitive уникальности названий
- Проверяет и добавляет колонку `fabric_id` в `warehouse_balances` (если её нет)
- Создаёт FK constraint `warehouse_balances.fabric_id -> warehouse_fabrics.id`
- Создаёт уникальный индекс на `(org_id, fabric_id)` для балансов

**Применение:**
```sql
-- Выполнить в SQL Editor Supabase
-- После выполнения:
NOTIFY pgrst, 'reload schema';
```

### 2. Исправление API для списка тканей

**Файл:** `src/app/api/warehouse/fabrics/list/route.ts`

**Изменения:**
- Убрал `!inner` (INNER JOIN) → теперь LEFT JOIN
- Упростил логику: один запрос вместо двух
- Баланс возвращается как объект, а не массив

### 3. UI: Добавление ткани в справочник

**Файл:** `src/app/app/inventory/ui.tsx`

**Добавлено:**
- Кнопка "+ Добавить" рядом с селектом ткани
- Модалка для создания новой ткани:
  - Название (обязательно)
  - Цвет (опционально)
  - Ширина, см (опционально)
  - Плотность (опционально)
- После создания:
  - Обновляется список тканей
  - Новая ткань автоматически выбирается в форме прихода

## Файлы изменены

1. `supabase/migrations/20250127_fix_warehouse_relationships.sql` (новый)
2. `src/app/api/warehouse/fabrics/list/route.ts` (исправлен)
3. `src/app/app/inventory/ui.tsx` (добавлена модалка)

## Как проверить

### Шаг 1: Применить миграцию
```sql
-- В SQL Editor Supabase выполнить:
-- 1. Открыть файл 20250127_fix_warehouse_relationships.sql
-- 2. Выполнить весь скрипт
-- 3. Выполнить: NOTIFY pgrst, 'reload schema';
```

### Шаг 2: Проверить создание ткани
1. Открыть `/app/inventory`
2. Вкладка "Ткань"
3. Нажать "+ Приход"
4. Нажать "+ Добавить" рядом с селектом "Ткань"
5. Заполнить:
   - Название: "Кулирка" (обязательно)
   - Цвет: "черный" (опционально)
   - Ширина: 180 (опционально)
   - Плотность: 200 (опционально)
6. Нажать "Создать"
7. Проверить: новая ткань выбрана в селекте

### Шаг 3: Проверить приход ткани
1. В форме прихода выбрать ткань (или использовать только что созданную)
2. Заполнить:
   - Рулоны: 5 (обязательно)
   - Метраж: 100 (опционально)
   - Сумма: 5000 (опционально)
3. Нажать "Оформить приход"
4. Проверить:
   - Форма закрылась
   - В таблице "Остатки" появилась запись с правильными данными
   - В таблице "Журнал операций" появилась запись "Приход"

### Шаг 4: Проверить уникальность названий
1. Попробовать создать ткань с тем же названием (например, "Кулирка")
2. Должна быть ошибка о дублировании (если в той же org)

## Важные замечания

1. **После миграции обязательно:** `NOTIFY pgrst, 'reload schema';`
2. **Уникальность:** Названия тканей уникальны case-insensitive в рамках одной org
3. **FK relationship:** Теперь PostgREST видит relationship и может делать join
4. **Балансы:** Создаются автоматически при первом приходе через RPC `warehouse_update_balance`

## Если что-то не работает

1. **Ошибка "Could not find a relationship":**
   - Проверить, что миграция применена
   - Выполнить `NOTIFY pgrst, 'reload schema';`
   - Перезагрузить страницу

2. **Ошибка при создании ткани (дублирование):**
   - Проверить, что название уникально (case-insensitive)
   - Проверить, что `org_id` правильный

3. **Балансы не обновляются:**
   - Проверить, что RPC `warehouse_update_balance` существует
   - Проверить логи в консоли браузера
